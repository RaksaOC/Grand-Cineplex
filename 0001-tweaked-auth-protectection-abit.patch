From c0e9553832b5142ff8d532ea5acfb299e411f6a0 Mon Sep 17 00:00:00 2001
From: Chanraksa Ory <OCraksa@gmail.com>
Date: Sun, 27 Jul 2025 16:37:08 +0700
Subject: [PATCH] tweaked auth protectection abit

---
 src/client/src/components/context/AuthContext.tsx        | 4 +++-
 src/client/src/components/context/StaffAuthContext.tsx   | 9 ++++++++-
 src/server/src/app/manager/controllers/userController.ts | 1 +
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/client/src/components/context/AuthContext.tsx b/src/client/src/components/context/AuthContext.tsx
index e88f3cf..13e0a05 100644
--- a/src/client/src/components/context/AuthContext.tsx
+++ b/src/client/src/components/context/AuthContext.tsx
@@ -43,7 +43,9 @@ export const AuthProvider = ({ children }: AuthProviderProps) => {
 
           if (userInfoString) {
             const userInfo = JSON.parse(userInfoString);
-            setAuth({ ...userInfo, exp: decoded.exp, token });
+            if (!userInfo.role) {
+              setAuth({ ...userInfo, exp: decoded.exp, token });
+            }
           } else {
             setAuth({ id: 0, name: "User", email: "", exp: decoded.exp, token });
           }
diff --git a/src/client/src/components/context/StaffAuthContext.tsx b/src/client/src/components/context/StaffAuthContext.tsx
index 4bbb37c..0eeb7fc 100644
--- a/src/client/src/components/context/StaffAuthContext.tsx
+++ b/src/client/src/components/context/StaffAuthContext.tsx
@@ -79,10 +79,17 @@ export const StaffAuthProvider = ({ children }: AuthProviderProps) => {
             const userInfo = JSON.parse(userInfoString);
             const userData = {
               ...userInfo,
-              role: decoded.role || userInfo.role || "cashier", // Default to cashier if no role
+              role: decoded.role || userInfo.role,
               exp: decoded.exp,
               token
             };
+
+            const path = window.location.pathname;
+            if (path.startsWith('/cashier') && userData.role === 'manager') {
+              navigate('/cashier/auth');
+            } else if (path.startsWith('/manager') && userData.role === 'cashier') {
+              navigate('/manager/auth');
+            }
             console.log("StaffAuthContext: Setting auth with user data:", userData);
             setAuth(userData);
 
diff --git a/src/server/src/app/manager/controllers/userController.ts b/src/server/src/app/manager/controllers/userController.ts
index f4c2b40..1d0dda5 100644
--- a/src/server/src/app/manager/controllers/userController.ts
+++ b/src/server/src/app/manager/controllers/userController.ts
@@ -177,6 +177,7 @@ export const logInUser = async (req: Request, res: Response) => {
       name: user.name,
       email: user.email,
       phone: user.phone,
+      role: user.role,
       token,
     });
   } catch (error) {
-- 
2.39.5 (Apple Git-154)

